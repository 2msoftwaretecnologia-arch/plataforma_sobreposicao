{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Análise de Imóvel Rural</title>
  
  <!-- Leaflet & Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
  <link rel="stylesheet" href="{% static 'analysis/css/report.css' %}" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <script src="{% static 'analysis/js/maps.js' %}"></script>
  <style>
      .report-map {
          width: 100%;
          height: 350px;
          margin-top: 15px;
          border-radius: 4px;
          border: 1px solid #e2e8f0;
          z-index: 0;
      }
  </style>
</head>
<body>

<div class="container">

  <!-- RESUMO GERAL -->

  <!-- INFORMAÇÕES GERAIS -->
  <section class="card">
    <h1 style="margin-bottom: 2rem;">Relatório de Análise de Imóvel Rural</h1>

    <h2>Informações do Imóvel</h2>
    <div class="info-list" style="margin-bottom: 1rem;">
        {% if resultado.tamanho_area %}
            <div>
                <strong>Área total</strong>
                <span>
                    {{ resultado.tamanho_area|floatformat:4 }} ha
                </span>
            </div>
        {% endif %}

        {% if municipio and uf %}
            <div>
                <strong>Município / UF</strong>
                <span>
                    {{ municipio }} - {{ uf }}                    
                </span>
            </div>
        {% endif %}
    </div>

    {% if recibo %}
        {% include "analysis/components/tables/receipt_table.html" with receipt=recibo %}
    {% endif %}

    {% if demonstrativo %}
        {% include "analysis/components/tables/statement_table.html" with statement=demonstrativo %}
    {% endif %}
  </section>

  <!-- ANÁLISE -->
  <section class="card">
    <h2>Resultado da Análise Automática</h2>
    <div class="pill-group">
      {% if demonstrativo %}
          <span class="pill green">Situação: {{ demonstrativo.registration_status|default:"Não informado" }}</span>
          <span class="pill blue">Condição: {{ demonstrativo.external_condicion|default:"Não informado" }}</span>
      {% endif %}
      
        {% if demonstrativo and demonstrativo.issue_rl_quote %}
            <span class="pill" style="background:#fee2e2; color:#991b1b;">Emite cota RL: {{ demonstrativo.passivo_ou_excedente_de_reserva_legal }}</span>
        {% else %}
            <span class="pill green">Emite cota RL: Não</span>
        {% endif %}

      {% if resultado.total_areas_com_sobreposicao == 0 %}
        <span class="pill green">Sem sobreposições</span>
      {% else %}
        <span class="pill" style="background:#fee2e2; color:#991b1b;">
            {{ resultado.total_areas_com_sobreposicao }} Sobreposições
        </span>
      {% endif %}
    </div>
  </section>

  <!-- CRITÉRIO AMBIENTAL -->
  <section class="card">
    <h2>Critério Ambiental <small>(autodeclarado)</small></h2>
    <div class="env-grid">
      <div class="env-box">
        <span class="env-title">Reserva Legal</span>
        <span class="env-value">
            {% if recibo and recibo.area_reserva_legal %}
                {{ recibo.area_reserva_legal }} ha
            {% else %}
                {{ resultado.area_preservada_total|floatformat:4|default:"0.0000" }} ha
            {% endif %}
        </span>
      </div>

      {% if demonstrativo %}
        <div class="env-box">
            <span class="env-title">Déficit de RL</span>
            {% if has_deficit_rl %}
                <span class="badge no" title="Déficit de RL">Sim</span>
                <div style="font-size:12px; margin-top:4px; color:#64748b;">
                    {{ deficit_rl_value }}
                </div>
            {% else %}
                <span class="badge yes">Não</span>
            {% endif %}
        </div>
    {% endif %}

      <div class="env-box">
        <span class="env-title">APP Antropizada</span>
        {% if recibo and recibo.area_antropizada and recibo.app_to_restore %}
             <span class="badge no">Sim</span>
             <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ recibo.area_antropizada }}</div>
        {% elif demonstrativo and demonstrativo.area_antropizada and demonstrativo.app_to_restore %}
             <span class="badge no">Sim</span>
             <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ demonstrativo.area_antropizada }}</div>
        {% else %}
             <span class="badge yes">Não</span>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- SOBREPOSIÇÕES -->
  <section class="card">
    <h2>Sobreposições Ativas</h2>

    {% if resultado.total_areas_com_sobreposicao > 0 %}
        <div class="alert warning">
          ⚠ Existem áreas com sobreposição ambiental
        </div>

        {% for base in resultado.resultados_por_base %}
            {% if base.areas_encontradas %}
                <div class="base-section">
                    <h3>{{ base.nome_base }}</h3>
                    <span class="base-count">{{ base.areas_encontradas|length }} ocorrência(s)</span>

                    {% if "Sigef" in base.nome_base %}
                        {% include "analysis/components/tables/sigef_table.html" with items=base.areas_encontradas %}
                    {% elif "Zoneamento" in base.nome_base %}
                        {% include "analysis/components/tables/zoning_table.html" with items=base.areas_encontradas %}
                    {% elif "Municípios" in base.nome_base or "Municipios" in base.nome_base or "Municpios" in base.nome_base %}
                        {% include "analysis/components/tables/municipal_boundaries_table.html" with items=base.areas_encontradas %}
                    {% elif "APAs" in base.nome_base %}
                        {% include "analysis/components/tables/environmental_protection_table.html" with items=base.areas_encontradas %}
                    {% elif "Indígenas" in base.nome_base or "Indigenas" in base.nome_base %}
                        {% include "analysis/components/tables/indigenous_table.html" with items=base.areas_encontradas %}
                    {% elif "Quilombolas" in base.nome_base %}
                        {% include "analysis/components/tables/quilombolas_table.html" with items=base.areas_encontradas %}
                    {% elif "Assentamentos" in base.nome_base %}
                        {% include "analysis/components/tables/rural_settlement_table.html" with items=base.areas_encontradas %}
                    {% elif "Sicar" in base.nome_base or "CAR" in base.nome_base %}
                        {% include "analysis/components/tables/sicar_table.html" with items=base.areas_encontradas %}
                    {% elif "Fitoecologias" in base.nome_base %}
                        {% include "analysis/components/tables/phytoecology_table.html" with items=base.areas_encontradas %}
                    {% elif "Veredas" in base.nome_base %}
                        {% include "analysis/components/tables/paths_table.html" with items=base.areas_encontradas %}
                    {% elif "Unidades de Conservação" in base.nome_base %}
                        {% include "analysis/components/tables/conservation_units_table.html" with items=base.areas_encontradas %}
                    {% elif "SNIC" in base.nome_base %}
                        {% include "analysis/components/tables/snic_total_table.html" with items=base.areas_encontradas %}
                    {% elif "Deforestação" in base.nome_base or "Mapbiomas" in base.nome_base %}
                        {% include "analysis/components/tables/deforestation_mapbiomas_table.html" with items=base.areas_encontradas %}
                    {% else %}
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in base.areas_encontradas %}
                                <tr>
                                    <td>{{ item.item_info|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}

                    <div id="map-base-{{ forloop.counter }}" class="report-map"></div>
                    <script>
                        (function(){
                            var items = [];
                        
                            // Sobreposições
                            {% for item in base.areas_encontradas %}
                                {% if item.polygon_geojson %}
                                    items.push({
                                        gj: {{ item.polygon_geojson|safe }},
                                        label: "{{ item.item_info|escapejs }}",
                                        area: "{{ item.area|default:'' }}",
                                        color: "{{ item.color|default:'#ef4444' }}",
                                        fonte: "{{ base.nome_base|escapejs }}"
                                    });
                                {% endif %}
                            {% endfor %}
                
                            // Inicializa mapa apenas se houver itens
                            if(items.length > 0){
                                initImoveisMap(items, {
                                    elementId: 'map-base-{{ forloop.counter }}',
                                    planet_tiles_url: '{{ planet_tiles_url|default:"" }}'
                                });
                            } else {
                                // Se não tiver geometria para mostrar, remove o container do mapa para não ficar espaço em branco
                                var el = document.getElementById('map-base-{{ forloop.counter }}');
                                if(el) el.style.display = 'none';
                            }
                        })();
                    </script>
                </div>
            {% endif %}
        {% endfor %}

    {% else %}
        <div class="alert" style="background: #dcfce7; color: #166534;">
          ✔ Nenhuma sobreposição identificada nas bases consultadas
        </div>
    {% endif %}
  </section>

  <footer class="footer">
    Relatório automático • Sistema de Análise Ambiental • {{ "now"|date:"d/m/Y H:i" }}
  </footer>
</div>

<script>
    window.addEventListener('load', function() {
        // Aguarda renderização dos mapas (tiles)
        setTimeout(function() {
            window.print();
        }, 1500);
    });
</script>

</body>
</html>
