{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>An√°lise de Im√≥vel Rural</title>
  
  <!-- Leaflet & Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
  <link rel="stylesheet" href="{% static 'analysis/css/report.css' %}" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <script src="{% static 'analysis/js/maps.js' %}"></script>
  <style>
      .report-map {
          width: 100%;
          height: 350px;
          margin-top: 15px;
          border-radius: 4px;
          border: 1px solid #e2e8f0;
          z-index: 0;
      }
  </style>
</head>
<body>

<div class="container">

  <!-- INFORMA√á√ïES GERAIS -->
  <section class="card">
    <div class="report-header">
        <h1>Relat√≥rio de An√°lise de Im√≥vel Rural</h1>
        <button type="button" class="print-btn" onclick="printReport()">
            üñ®Ô∏è Imprimir PDF
        </button>
    </div>
    <h2>Detalhes</h2>
    <div class="info-list" style="margin-bottom: 1rem;">
        <div>
            <strong>Nome do Propriet√°rio</strong>
            <span contenteditable="true" class="editable-field" data-placeholder="Clique para editar"></span>
        </div>
        <div>
            <strong>Nome da Fazenda</strong>
            <span contenteditable="true" class="editable-field" data-placeholder="Clique para editar"></span>
        </div>

        {% if resultado.tamanho_area %}
            <div>
                <strong>√Årea total (ha)</strong>
                <span>
                    {{ resultado.tamanho_area|floatformat:4 }}
                </span>
            </div>

            
            

        {% endif %}

        {% if municipio and uf %}
            <div>
                <strong>Munic√≠pio / UF</strong>
                <span>
                    {{ municipio }} - {{ uf }}                    
                </span>
            </div>
        {% endif %}

         {% if demonstrativo %}
            <div>
                <strong>Situa√ß√£o</strong>
                <span>
                    {{ demonstrativo.registration_status|default:"N√£o informado" }}                    
                </span>
            </div>
            
            <div>
                <strong>Condi√ß√£o</strong>
                <span>
                    {{ demonstrativo.external_condicion|default:"N√£o informado" }}                    
                </span>
            </div>
        {% endif %}

        {% if demonstrativo %}
            <div>
                <strong>Reserva Legal Declarada</strong>
                <span>{{ demonstrativo.area_reserva_legal_proposta|default:"-" }} ha</span>
            </div>
        {% endif %}

        <div>
            <strong>Reserva Legal Necessaria</strong>
            <span>
                {% if recibo and recibo.area_reserva_legal %}
                    {{ recibo.area_reserva_legal }} ha
                {% else %}
                    {{ resultado.area_preservada_total|floatformat:4|default:"0,0000" }} ha
                {% endif %}
            </span>
        </div>

        {% if has_deficit_rl %}
            <div>
                <strong>Tem D√©ficit de RL?</strong>
                <span>
                    Sim {{ deficit_rl_value|cut:"-"}}                    
                </span>
            </div>
        {% else %}
            <div>
                <strong>Tem D√©ficit de RL?</strong>
                <span>N√£o</span>
            </div>
        {% endif %}

        {% if demonstrativo %}
            {% if demonstrativo.issue_rl_quote %}
                <div>
                    <strong>Pode Emitir cota RL?</strong>
                    <span>
                        Sim {{ demonstrativo.passivo_ou_excedente_de_reserva_legal|cut:"-" }} ha
                    </span>
                </div>
            {% else %}
                <div>
                    <strong>Pode Emitir cota RL?</strong>
                    <span>N√£o</span>
                </div>
            {% endif %}
        {% endif %}

        <div>
            <strong>Tem APP Antropizada?</strong>
            {% if recibo and recibo.area_antropizada and recibo.app_to_restore %}
                <span>{{ recibo.area_antropizada }}</span>
            {% elif demonstrativo and demonstrativo.area_antropizada and demonstrativo.app_to_restore %}
                <span>{{ demonstrativo.area_antropizada }}</span>
            {% else %}
                <span>N√£o</span>
            {% endif %}
        </div>

        {% for base in resultado.resultados_por_base %}
            {% if "Fitoecologias" in base.nome_base and base.areas_encontradas %}
                <div>
                    <strong>Bioma(s)</strong>
                    <span>
                        {% regroup base.areas_encontradas|dictsort:"item_info" by item_info as fito_list %}
                        {% for fito in fito_list %}
                            {% if "Cerrado" in fito.grouper %}üåæ{% elif "Floresta" in fito.grouper %}üå≥{% endif %}
                            {{ fito.grouper }} <strong>({{ fito.list.0.area|floatformat:4 }} ha)</strong>{% if not forloop.last %} &nbsp;|&nbsp; {% endif %}
                        {% endfor %}
                    </span>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if recibo %}
        {% include "analysis/components/tables/receipt_table.html" with receipt=recibo %}
    {% endif %}

    {% if demonstrativo %}
        {% include "analysis/components/tables/statement_table.html" with statement=demonstrativo %}
    {% endif %}
  </section>

  <!-- SOBREPOSI√á√ïES -->
  <section class="card">
    <h2>Sobreposi√ß√µes Ativas</h2>

    {% if resultado.total_areas_com_sobreposicao > 0 %}

        {% for base in resultado.resultados_por_base %}
            {% if base.areas_encontradas %}
                <div class="base-section">
                    <h3>{{ base.nome_base }}</h3>
                    <span class="base-count">{{ base.areas_encontradas|length }} ocorr√™ncia(s)</span>

                    {% if "Sigef" in base.nome_base %}
                        {% include "analysis/components/tables/sigef_table.html" with items=base.areas_encontradas %}
                    {% elif "Zoneamento" in base.nome_base %}
                        {% include "analysis/components/tables/zoning_table.html" with items=base.areas_encontradas %}
                    {% elif "Munic√≠pios" in base.nome_base or "Municipios" in base.nome_base or "Municpios" in base.nome_base %}
                        {% include "analysis/components/tables/municipal_boundaries_table.html" with items=base.areas_encontradas %}
                    {% elif "APAs" in base.nome_base %}
                        {% include "analysis/components/tables/environmental_protection_table.html" with items=base.areas_encontradas %}
                    {% elif "Ind√≠genas" in base.nome_base or "Indigenas" in base.nome_base %}
                        {% include "analysis/components/tables/indigenous_table.html" with items=base.areas_encontradas %}
                    {% elif "Quilombolas" in base.nome_base %}
                        {% include "analysis/components/tables/quilombolas_table.html" with items=base.areas_encontradas %}
                    {% elif "Assentamentos" in base.nome_base %}
                        {% include "analysis/components/tables/rural_settlement_table.html" with items=base.areas_encontradas %}
                    {% elif "Sicar" in base.nome_base or "CAR" in base.nome_base %}
                        {% include "analysis/components/tables/sicar_table.html" with items=base.areas_encontradas %}
                    {% elif "Fitoecologias" in base.nome_base %}
                        {% include "analysis/components/tables/phytoecology_table.html" with items=base.areas_encontradas %}
                    {% elif "Veredas" in base.nome_base %}
                        {% include "analysis/components/tables/paths_table.html" with items=base.areas_encontradas total_area=base.total_area %}
                    {% elif "IPUCA" in base.nome_base %}
                        {% include "analysis/components/tables/ipuca_table.html" with items=base.areas_encontradas total_area=base.total_area %}
                    {% elif "Unidades de Conserva√ß√£o" in base.nome_base %}
                        {% include "analysis/components/tables/conservation_units_table.html" with items=base.areas_encontradas %}
                    {% elif "SNIC" in base.nome_base %}
                        {% include "analysis/components/tables/snic_total_table.html" with items=base.areas_encontradas %}
                    {% elif "Deforesta√ß√£o" in base.nome_base or "Mapbiomas" in base.nome_base %}
                        {% include "analysis/components/tables/deforestation_mapbiomas_table.html" with items=base.areas_encontradas %}
                    {% elif "Embargos" in base.nome_base %}
                        {% include "analysis/components/tables/embargoes_table.html" with items=base.areas_encontradas %}
                    {% else %}
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in base.areas_encontradas %}
                                <tr>
                                    <td>{{ item.item_info|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}

                    <div id="map-base-{{ forloop.counter }}" class="report-map"></div>
                    <script>
                        (function(){
                            var items = [];
                        
                            // Sobreposi√ß√µes
                            {% for item in base.areas_encontradas %}
                                {% if item.polygon_geojson %}
                                    items.push({
                                        gj: {{ item.polygon_geojson|safe }},
                                        label: "{{ item.item_info|escapejs }}",
                                        area: "{{ item.area|default:'' }}",
                                        color: "{{ item.color|default:'#ef4444' }}",
                                        fonte: "{{ base.nome_base|escapejs }}"
                                    });
                                {% endif %}
                            {% endfor %}
                
                            // Inicializa mapa apenas se houver itens
                            if(items.length > 0){
                                initImoveisMap(items, {
                                    elementId: 'map-base-{{ forloop.counter }}',
                                    planet_tiles_url: '{{ planet_tiles_url|default:"" }}',
                                    isStatic: true,
                                    scrollWheelZoom: false,
                                    fullscreenControl: false
                                });
                            } else {
                                // Se n√£o tiver geometria para mostrar, remove o container do mapa para n√£o ficar espa√ßo em branco
                                var el = document.getElementById('map-base-{{ forloop.counter }}');
                                if(el) el.style.display = 'none';
                            }
                        })();
                    </script>
                </div>
            {% endif %}
        {% endfor %}

    {% else %}
        <div class="alert" style="background: #dcfce7; color: #166534;">
          ‚úî Nenhuma sobreposi√ß√£o identificada nas bases consultadas
        </div>
    {% endif %}
  </section>

  <footer class="footer">
    {{ "now"|date:"d/m/Y H:i" }}
  </footer>

            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td>
                <div class="footer-space">&nbsp;</div>
            </td>
        </tr>
    </tfoot>
  </table>
</div>

<script>

    function printReport() {
        window.print();
    }

    // Prevent newlines in editable fields
    document.querySelectorAll('.editable-field').forEach(field => {
        field.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                field.blur();
            }
        });
        
        // Paste as plain text
        field.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
        });
    });

</script>

</body>
</html>
