{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>An√°lise de Im√≥vel Rural</title>
  <link rel="stylesheet" href="{% static 'analysis/css/report.css' %}" />
  <script>
    window.onload = function() {
        // Automatically open print dialog
        setTimeout(function() {
            window.print();
        }, 500);
    }
  </script>
</head>
<body>

<div class="container">

  <!-- RESUMO GERAL -->
  <section class="summary">
    <div class="summary-status ok">
        {% if resultado.total_areas_com_sobreposicao == 0 %}
            ‚úî IM√ìVEL EM CONFORMIDADE
        {% else %}
            ‚ö† IM√ìVEL COM SOBREPOSI√á√ïES
        {% endif %}
    </div>
    <div class="summary-sub">
        {% if recibo and recibo.nome_imovel_rural %}
            {{ recibo.nome_imovel_rural }}
        {% elif demonstrativo and demonstrativo.car %}
            Im√≥vel CAR {{ demonstrativo.car }}
        {% else %}
            Im√≥vel Rural
        {% endif %}
        
        {% if municipio or uf %}
            ‚Ä¢ {{ municipio }} / {{ uf }}
        {% endif %}
    </div>
  </section>

  <!-- INFORMA√á√ïES GERAIS -->
  <section class="card">
    <h2>üìç Informa√ß√µes do Im√≥vel</h2>
    <div class="info-list">
        {% if recibo and recibo.nome_imovel_rural %}
            <div>
                <strong>Nome do im√≥vel</strong>
                <span>{{ recibo.nome_imovel_rural }}</span>
            </div>
        {% endif %}

        {% if recibo and recibo.proprietarios %}
            <div>
                <strong>Propriet√°rio</strong>
                <span>
                    {{ recibo.proprietarios.0.nome }}
                </span>
            </div>
        {% endif %}
    
        {% if resultado.tamanho_area %}
            <div>
                <strong>√Årea total</strong>
                <span>
                    {{ resultado.tamanho_area|floatformat:4 }} ha
                </span>
            </div>
        {% endif %}

        <div>
            <strong>M√≥dulos fiscais</strong>
            <span>
                {% if recibo and recibo.modulos_fiscais %}
                    {{ recibo.modulos_fiscais }}
                {% elif demonstrativo and demonstrativo.tax_modules %}
                    {{ demonstrativo.tax_modules }}
                {% endif %}
            </span>
        </div>

        {% if municipio and uf %}
            <div>
                <strong>Munic√≠pio / UF</strong>
                <span>
                    {{ municipio }} - {{ uf }}                    
                </span>
            </div>
        {% endif %}
    </div>
  </section>

  <!-- AN√ÅLISE -->
  <section class="card">
    <h2>üß™ Resultado da An√°lise Autom√°tica</h2>
    <div class="pill-group">
      {% if demonstrativo %}
          <span class="pill green">Situa√ß√£o: {{ demonstrativo.registration_status|default:"N√£o informado" }}</span>
          <span class="pill blue">Condi√ß√£o: {{ demonstrativo.external_condicion|default:"N√£o informado" }}</span>
      {% endif %}
      
        {% if demonstrativo and demonstrativo.has_deficit_rl %}
            <span class="pill" style="background:#fee2e2; color:#991b1b;">Emite cota RL: {{ demonstrativo.passivo_ou_excedente_de_reserva_legal }}</span>
        {% else %}
            <span class="pill green">Emite cota RL: N√£o</span>
        {% endif %}

      {% if resultado.total_areas_com_sobreposicao == 0 %}
        <span class="pill green">Sem sobreposi√ß√µes</span>
      {% else %}
        <span class="pill" style="background:#fee2e2; color:#991b1b;">
            {{ resultado.total_areas_com_sobreposicao }} Sobreposi√ß√µes
        </span>
      {% endif %}
    </div>
  </section>

  <!-- CRIT√âRIO AMBIENTAL -->
  <section class="card">
    <h2>üå± Crit√©rio Ambiental <small>(autodeclarado)</small></h2>
    <div class="env-grid">
      <div class="env-box">
        <span class="env-title">Reserva Legal</span>
        <span class="env-value">
            {% if recibo and recibo.area_reserva_legal %}
                {{ recibo.area_reserva_legal }} ha
            {% else %}
                {{ resultado.area_preservada_total|floatformat:4|default:"0.0000" }} ha
            {% endif %}
        </span>
      </div>''

      {% if demonstrativo %}
        <div class="env-box">
            <span class="env-title">D√©ficit de RL</span>
            {% if 0 > (demonstrativo.area_reserva_legal_proposta_num - resultado.area_preservada_total) %}
                <span class="badge no" title="{{ (demonstrativo.area_reserva_legal_proposta_num - resultado.area_preservada_total)}}">N√£o</span>
                <div style="font-size:12px; margin-top:4px; color:#64748b;">
                    {{ demonstrativo.passivo_ou_excedente_de_reserva_legal }}
                </div>
            {% else %}
                <span class="badge yes">N√£o</span>
            {% endif %}
        </div>
        {% endif %}

      <div class="env-box">
        <span class="env-title">APP Antropizada</span>
        {% if recibo and recibo.area_antropizada and recibo.app_to_restore %}
             <span class="badge no">Sim</span>
             <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ recibo.area_antropizada }}</div>
        {% elif demonstrativo and demonstrativo.area_antropizada and demonstrativo.app_to_restore %}
             <span class="badge no">Sim</span>
             <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ demonstrativo.area_antropizada }}</div>
        {% else %}
             <span class="badge yes">N√£o</span>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- SOBREPOSI√á√ïES -->
  <section class="card">
    <h2>üó∫Ô∏è Sobreposi√ß√µes Ativas</h2>

    {% if resultado.total_areas_com_sobreposicao > 0 %}
        <div class="alert warning">
          ‚ö† Existem √°reas com sobreposi√ß√£o ambiental
        </div>

        {% for base in resultado.resultados_por_base %}
            {% if base.areas_encontradas %}
                <div class="base-section">
                    <h3>{{ base.nome_base }}</h3>
                    <span class="base-count">{{ base.areas_encontradas|length }} ocorr√™ncia(s)</span>

                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>√Årea (ha)</th>
                                {% if "Sigef" in base.nome_base %}
                                    <th>Nome</th>
                                    <th>Status</th>
                                {% elif "Zoneamento" in base.nome_base %}
                                    <th>Zona</th>
                                    <th>Sigla</th>
                                {% elif "Munic√≠pios" in base.nome_base or "Municipios" in base.nome_base or "Municpios" in base.nome_base %}
                                    <th>Munic√≠pio</th>
                                {% elif "APAs" in base.nome_base %}
                                    <th>Unidade</th>
                                    <th>Dom√≠nios</th>
                                    <th>Classe</th>
                                {% elif "Terras Ind√≠genas" in base.nome_base or "Indigenas" in base.nome_base %}
                                    <th>Terra Ind√≠gena</th>
                                    <th>Etnia</th>
                                    <th>Fase</th>
                                {% elif "Quilombolas" in base.nome_base %}
                                    <th>Comunidade</th>
                                    <th>Fase</th>
                                {% elif "Embargos" in base.nome_base %}
                                    <th>C√≥digo</th>
                                    <th>Data</th>
                                {% elif "Assentamentos" in base.nome_base %}
                                    <th>Projeto</th>
                                    <th>Fase</th>
                                {% elif "CAR" in base.nome_base %}
                                    <th>Recibo</th>
                                    <th>Status</th>
                                {% else %}
                                    <th>Detalhes</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in base.areas_encontradas %}
                            <tr>
                                <td>{{ item.area|floatformat:4 }}</td>
                                {% if "Sigef" in base.nome_base %}
                                    <td>{{ item.nome }}</td>
                                    <td>{{ item.status }}</td>
                                {% elif "Zoneamento" in base.nome_base %}
                                    <td>{{ item.zona }}</td>
                                    <td>{{ item.sigla }}</td>
                                {% elif "Munic√≠pios" in base.nome_base or "Municipios" in base.nome_base or "Municpios" in base.nome_base %}
                                    <td>{{ item.name }}</td>
                                {% elif "APAs" in base.nome_base %}
                                    <td>{{ item.unidade }}</td>
                                    <td>{{ item.dominios }}</td>
                                    <td>{{ item.classe }}</td>
                                {% elif "Terras Ind√≠genas" in base.nome_base or "Indigenas" in base.nome_base %}
                                    <td>{{ item.terras_indigenas }}</td>
                                    <td>{{ item.etnia }}</td>
                                    <td>{{ item.fase }}</td>
                                {% elif "Quilombolas" in base.nome_base %}
                                    <td>{{ item.comunidade }}</td>
                                    <td>{{ item.fase }}</td>
                                {% elif "Embargos" in base.nome_base %}
                                    <td>{{ item.codigo_embargo }}</td>
                                    <td>{{ item.data_autuacao }}</td>
                                {% elif "Assentamentos" in base.nome_base %}
                                    <td>{{ item.nome_projeto }}</td>
                                    <td>{{ item.fase }}</td>
                                {% elif "CAR" in base.nome_base %}
                                    <td>{{ item.cod_imovel }}</td>
                                    <td>{{ item.ind_status_imovel }}</td>
                                {% else %}
                                    <td>{{ item.item_info|default:"-" }}</td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        {% endfor %}

    {% else %}
        <div class="alert" style="background: #dcfce7; color: #166534;">
          ‚úî Nenhuma sobreposi√ß√£o identificada nas bases consultadas
        </div>
    {% endif %}
  </section>

  <footer class="footer">
    Relat√≥rio autom√°tico ‚Ä¢ Sistema de An√°lise Ambiental ‚Ä¢ {{ "now"|date:"d/m/Y H:i" }}
  </footer>

</div>

</body>
</html>
