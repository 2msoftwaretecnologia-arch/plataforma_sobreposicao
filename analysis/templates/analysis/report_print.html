{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>An√°lise de Im√≥vel Rural</title>
  <link rel="stylesheet" href="{% static 'analysis/css/report.css' %}" />
  <script>
    window.onload = function() {
        // Automatically open print dialog
        setTimeout(function() {
            window.print();
        }, 500);
    }
  </script>
</head>
<body>

<div class="container">

  <!-- RESUMO GERAL -->
  <section class="summary">
    <div class="summary-status ok">
        {% if resultado.total_areas_com_sobreposicao == 0 %}
            ‚úî IM√ìVEL EM CONFORMIDADE
        {% else %}
            ‚ö† IM√ìVEL COM SOBREPOSI√á√ïES
        {% endif %}
    </div>
    <div class="summary-sub">
        {% if recibo and recibo.nome_imovel_rural %}
            {{ recibo.nome_imovel_rural }}
        {% elif demonstrativo and demonstrativo.car %}
            Im√≥vel CAR {{ demonstrativo.car }}
        {% else %}
            Im√≥vel Rural
        {% endif %}
        
        {% if municipio or uf %}
            ‚Ä¢ {{ municipio }} / {{ uf }}
        {% endif %}
    </div>
  </section>

  <!-- INFORMA√á√ïES GERAIS -->
  <section class="card">
    <h2>üìç Informa√ß√µes do Im√≥vel</h2>
    <div class="info-list">
      <div><strong>Nome do im√≥vel</strong><span>
          {% if recibo and recibo.nome_imovel_rural %}
              {{ recibo.nome_imovel_rural }}
          {% else %}
              ‚Äî
          {% endif %}
      </span></div>
      <div><strong>Propriet√°rio</strong><span>
          {% if recibo and recibo.proprietarios %}
              {{ recibo.proprietarios.0.nome }}
          {% else %}
              ‚Äî
          {% endif %}
      </span></div>
      <div><strong>√Årea total</strong><span>
          {% if recibo and recibo.area_liquida_do_imovel %}
              {{ recibo.area_liquida_do_imovel }}
          {% elif resultado.tamanho_area %}
              {{ resultado.tamanho_area|floatformat:4 }} ha
          {% else %}
              ‚Äî
          {% endif %}
      </span></div>
      <div><strong>M√≥dulos fiscais</strong><span>
          {% if recibo and recibo.modulos_fiscais %}
              {{ recibo.modulos_fiscais }}
          {% elif demonstrativo and demonstrativo.tax_modules %}
              {{ demonstrativo.tax_modules }}
          {% else %}
              ‚Äî
          {% endif %}
      </span></div>
      <div><strong>Munic√≠pio / UF</strong><span>
          {% if municipio %}{{ municipio }}{% endif %}{% if municipio and uf %} - {% endif %}{% if uf %}{{ uf }}{% endif %}
      </span></div>
    </div>
  </section>

  <!-- AN√ÅLISE -->
  <section class="card">
    <h2>üß™ Resultado da An√°lise Autom√°tica</h2>
    <div class="pill-group">
      {% if demonstrativo %}
          <span class="pill green">Situa√ß√£o: {{ demonstrativo.registration_status|default:"N√£o informado" }}</span>
          <span class="pill blue">Condi√ß√£o: {{ demonstrativo.external_condicion|default:"N√£o informado" }}</span>
      {% endif %}
      
      {% if recibo %}
          <span class="pill green">CAR: {{ recibo.car }}</span>
      {% elif demonstrativo %}
           <span class="pill green">CAR: {{ demonstrativo.car }}</span>
      {% elif car_input %}
           <span class="pill green">CAR: {{ car_input }}</span>
      {% endif %}

      {% if resultado.total_areas_com_sobreposicao == 0 %}
        <span class="pill green">Sem sobreposi√ß√µes</span>
      {% else %}
        <span class="pill" style="background:#fee2e2; color:#991b1b;">{{ resultado.total_areas_com_sobreposicao }} Sobreposi√ß√µes</span>
      {% endif %}
    </div>
  </section>

  <!-- CRIT√âRIO AMBIENTAL -->
  <section class="card">
    <h2>üå± Crit√©rio Ambiental <small>(autodeclarado)</small></h2>
    <div class="env-grid">
      <div class="env-box">
        <span class="env-title">Reserva Legal</span>
        <span class="env-value">
            {% if recibo and recibo.area_reserva_legal %}
                {{ recibo.area_reserva_legal }}
            {% elif demonstrativo and demonstrativo.total_reserva_legal_declarada_pelo_proprietario_possuidor %}
                {{ demonstrativo.total_reserva_legal_declarada_pelo_proprietario_possuidor }}
            {% else %}
                ‚Äî
            {% endif %}
        </span>
      </div>

      <div class="env-box">
        <span class="env-title">D√©ficit de RL</span>
        {# L√≥gica simplificada: Se houver valor de passivo, exibe, sen√£o 'N√£o' #}
        {% if demonstrativo and demonstrativo.passivo_ou_excedente_de_reserva_legal and "0,0000" not in demonstrativo.passivo_ou_excedente_de_reserva_legal %}
            <span class="badge no" title="{{ demonstrativo.passivo_ou_excedente_de_reserva_legal }}">Sim</span>
            <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ demonstrativo.passivo_ou_excedente_de_reserva_legal }}</div>
        {% else %}
            <span class="badge yes">N√£o</span>
        {% endif %}
      </div>

      <div class="env-box">
        <span class="env-title">APP Antropizada</span>
        {% if recibo and recibo.area_antropizada and "0,0000" not in recibo.area_antropizada and "0.0000" not in recibo.area_antropizada %}
             <span class="badge no">Sim</span>
             <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ recibo.area_antropizada }}</div>
        {% elif demonstrativo and demonstrativo.area_antropizada and "0,0000" not in demonstrativo.area_antropizada and "0.0000" not in demonstrativo.area_antropizada %}
             <span class="badge no">Sim</span>
             <div style="font-size:12px; margin-top:4px; color:#64748b;">{{ demonstrativo.area_antropizada }}</div>
        {% else %}
             <span class="badge yes">N√£o</span>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- SOBREPOSI√á√ïES -->
  <section class="card">
    <h2>üó∫Ô∏è Sobreposi√ß√µes Ativas</h2>

    {% if resultado.total_areas_com_sobreposicao > 0 %}
        <div class="alert warning">
          ‚ö† Existem √°reas com sobreposi√ß√£o ambiental
        </div>

        <ul class="overlay-list">
        {% for base in resultado.resultados_por_base %}
            {% if base.areas_encontradas %}
                <li><strong>{{ base.nome_base }}</strong>: {{ base.areas_encontradas|length }} ocorr√™ncia(s)</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% else %}
        <div class="alert" style="background: #dcfce7; color: #166534;">
          ‚úî Nenhuma sobreposi√ß√£o identificada nas bases consultadas
        </div>
    {% endif %}
  </section>

  <footer class="footer">
    Relat√≥rio autom√°tico ‚Ä¢ Sistema de An√°lise Ambiental ‚Ä¢ {{ "now"|date:"d/m/Y H:i" }}
  </footer>

</div>

</body>
</html>
