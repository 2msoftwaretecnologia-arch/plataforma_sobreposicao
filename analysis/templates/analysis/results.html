{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados da An√°lise</title>

    <link rel="stylesheet" type="text/css" href="{% static 'analysis/css/index.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'analysis/css/background_ocean.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    </head>

<body>
    <div class="ocean-backdrop"><div class="island-backdrop"></div></div>
    <svg height="0" width="0">
        <filter id="handDrawnNoise">
            <feTurbulence result="noise" numOctaves="5" baseFrequency="0.0065" type="fractalNoise" />
            <feDisplacementMap yChannelSelector="G" xChannelSelector="R" scale="900" in2="noise" in="SourceGraphic" />
        </filter>
    </svg>
    <div class="page">

        <header class="header">
            <div class="brand">
                <div class="brand-icon">üß≠</div>
                <div>
                    <p class="brand-label">Geo Monitor</p>
                    <h1 class="brand-title">An√°lise de Sobreposi√ß√£o</h1>
                </div>
            </div>

            <a class="ghost-button" href="{% url 'upload_zip_car' %}">
                üì¶ Upload de ZIP ou CAR
            </a>
        </header>

        {% if municipio or uf %}
        <section class="panel">
            <div class="panel-header">
                <span class="pill">Localiza√ß√£o</span>
                <div class="location-summary">
                    {% if municipio %}
                        <span class="badge badge-strong">{{ municipio }}</span>
                    {% endif %}
                    {% if uf %}
                        <span class="badge">{{ uf }}</span>
                    {% endif %}
                </div>
            </div>
            <p class="panel-description">
                Identificamos automaticamente o munic√≠pio e estado pertencentes ao pol√≠gono informado.
            </p>
        </section>
        {% endif %}

        {% if demonstrativo %}
            {% include "analysis/components/_demonstrativo_cards.html" %}
        {% endif %}

        {% if recibo %}
            {% include "analysis/components/_recibo_cards.html" %}
        {% endif %}

        {% if erro %}
        <section class="alert">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div>
                <p class="alert-title">Algo n√£o deu certo</p>
                <p class="alert-text">{{ erro }}</p>
            </div>
        </section>
        {% endif %}

        {% if resultado %}
        <section class="panel">
            <div class="panel-header">
                <div>
                    <p class="eyebrow">Resumo da execu√ß√£o</p>
                    <h2 class="panel-title">Resultados da An√°lise</h2>
                </div>
                <span class="badge">Consulta conclu√≠da</span>
            </div>

            <div class="summary-grid">
                <div class="summary-card">
                    <p class="summary-label">√Åreas com Sobreposi√ß√£o</p>
                    <p class="summary-value">{{ resultado.total_areas_com_sobreposicao }}</p>
                    <p class="summary-detail">Total de intersec√ß√µes encontradas</p>
                </div>

                <div class="summary-card">
                    <p class="summary-label">Tamanho da √Årea (ha)</p>
                    <p class="summary-value">
                        {% if resultado.tamanho_area != None %}
                            {% localize on %}
                                {{ resultado.tamanho_area|floatformat:4 }}
                            {% endlocalize %}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                    <p class="summary-detail">Extens√£o do pol√≠gono analisado</p>
                </div>

                <div class="summary-card">
                    <p class="summary-label">Tempo de An√°lise</p>
                    <p class="summary-value">
                        {% if resultado.tempo_execucao_formatado %}
                            {{ resultado.tempo_execucao_formatado }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                    <p class="summary-detail">Dura√ß√£o total da execu√ß√£o</p>
                </div>
            </div>

            {% include "analysis/components/_resultados_por_base.html" %}
        </section>
        {% endif %}

        {% if resultado and resultado.poligonos_imoveis %}
        <section class="panel">
            <div class="panel-header">
                <div>
                    <h class="panel-title">Mapa</h>
                </div>
            </div>

            <div id="map-imoveis"></div>
            <div id="legend-imoveis"></div>
        </section>
        <style>
            #map-imoveis{height:480px;border:1px solid var(--line);border-radius:var(--radius);}
            #legend-imoveis{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
            .legend-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:12px;font-size:12px}
            .legend-swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,0.15)}
            .legend-item.off{opacity:.5}
        </style>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            (function(){
                var items = [];

                items.push({
                    gj: {{ resultado.alvo_geojson|safe }},
                    label: "√Årea da Propriedade",
                    area: "{{ resultado.tamanho_area|floatformat:4 }} ha",
                    color: "#000000",
                    fonte: "√Årea da Propriedade"
                });

                {% for p in resultado.poligonos_imoveis %}
                    items.push({
                        gj: {{ p.polygon_geojson|safe }},
                        label: "{{ p.item_info|escapejs }}",
                        area: "{{ p.area|floatformat:4 }} ha",
                        color: "{{ p.color }}",
                        fonte: "{{ p.fonte|escapejs }}"
                    });

                {% endfor %}
                if(!items.length) return;
                var map = L.map('map-imoveis');
                var baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
                var baseEsriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
                var baseCartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:20});
                var baseTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17});
                baseOSM.addTo(map);
                var overlays = {};
                var layersByFonte = {};
                var allGroup = L.featureGroup().addTo(map);
                var legend = {};
                for(var i=0;i<items.length;i++){
                    try{
                        var gj = items[i].gj;
                        if (!gj) continue;
                        var geom = typeof gj === 'string' ? JSON.parse(gj) : gj;

                        if(!geom) continue;
                        var col = items[i].color || '#d9480f';
                        var f = items[i].fonte || 'Fonte';
                        var lbl = items[i].label || '';
                        var area = items[i].area || '';
                        if(!layersByFonte[f]){
                            layersByFonte[f] = L.featureGroup().addTo(map);
                            overlays[f] = layersByFonte[f];
                        }
                        var layer = L.geoJSON(geom,{style:{color:col,weight:2,fillColor:col,fillOpacity:0.35}});
                        var tt = [lbl || f, area].filter(function(x){ return x && (''+x).trim() !== ''; }).join('<br> √Årea: ');
                        (function(tt){
                            layer.eachLayer(function(fl){
                                if(tt){ fl.bindTooltip(tt,{sticky:true}); }
                                fl.on('mouseover',function(e){ e.target.setStyle({weight:3,fillOpacity:0.5}); });
                                fl.on('mouseout',function(e){ e.target.setStyle({weight:2,fillOpacity:0.35}); });
                            });
                        })(tt);
                        layer.addTo(layersByFonte[f]);
                        allGroup.addLayer(layer);
                        if(f && col){ legend[f] = col; }
                    }catch(e){}
                }
                if(allGroup.getLayers().length){
                    map.fitBounds(allGroup.getBounds(),{padding:[12,12]});
                }
                L.control.layers({
                    'OpenStreetMap': baseOSM,
                    'Sat√©lite (Esri)': baseEsriSat,
                    'Carto Light': baseCartoLight,
                    'OpenTopoMap': baseTopo
                }, overlays, {collapsed:false}).addTo(map);
                var legendEl = document.getElementById('legend-imoveis');
                var keys = Object.keys(legend);
                for(var j=0;j<keys.length;j++){
                    var k = keys[j];
                    var item = document.createElement('div');
                    item.className = 'legend-item';
                    var sw = document.createElement('span');
                    sw.className = 'legend-swatch';
                    sw.style.backgroundColor = legend[k];
                    var lbl = document.createElement('span');
                    lbl.textContent = k;
                    item.appendChild(sw);
                    item.appendChild(lbl);
                    item.dataset.fonte = k;
                    item.addEventListener('click', function(){
                        var fonte = this.dataset.fonte;
                        var grp = layersByFonte[fonte];
                        if(!grp) return;
                        if(map.hasLayer(grp)){
                            map.removeLayer(grp);
                            this.classList.add('off');
                        }else{
                            map.addLayer(grp);
                            this.classList.remove('off');
                        }
                    });
                    legendEl.appendChild(item);
                }
            })();
        </script>
        {% endif %}

        <section class="panel">
            <div class="panel-header">
                <div>
                    <p class="eyebrow">Guia r√°pido</p>
                    <h2 class="panel-title">Como usar a an√°lise</h2>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-block">
                    <p class="info-title">Prepara√ß√£o</p>
                    <ul>
                        <li>Cole as coordenadas WKT ou carregue um zip/shapefile/CAR.</li>
                        <li>Verifique se a geometria √© v√°lida e fechada.</li>
                    </ul>
                </div>
                <div class="info-block">
                    <p class="info-title">Bases consultadas</p>
                    <ul>
                        <li>Im√≥veis SICAR/CAR</li>
                        <li>Zoneamento territorial</li>
                        <li>Fitoecologias</li>
                        <li>APAs</li>
                    </ul>
                </div>
                <div class="info-block">
                    <p class="info-title">Interpreta√ß√£o</p>
                    <ul>
                        <li>As sobreposi√ß√µes s√£o agrupadas por base.</li>
                        <li>Use os valores e status para priorizar a√ß√µes.</li>
                    </ul>
                </div>
            </div>
        </section>
    </div>
</body>
</html>
